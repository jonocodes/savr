(function() {
    // 'use strict';

    // encoding generated by https://www.svgviewer.dev/svg-to-data-uri
    // using circle.svg . using img tag since direct svg xml had a weird background color
    const logoSvgBase64uri = "data:image/svg+xml;base64,PHN2ZwogICB3aWR0aD0iMTYuODk0Mjc4bW0iCiAgIGhlaWdodD0iMTYuODk0Mjc4bW0iCiAgIHZpZXdCb3g9IjAgMCAxNi44OTQyNzggMTYuODk0Mjc4IgogICB2ZXJzaW9uPSIxLjEiCiAgIGlkPSJzdmcxIgogICB4bWw6c3BhY2U9InByZXNlcnZlIgogICB4bWxuczp4bGluaz0iaHR0cDovL3d3dy53My5vcmcvMTk5OS94bGluayIKICAgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIgogICB4bWxuczpzdmc9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZGVmcwogICAgIGlkPSJkZWZzMSI+PGxpbmVhckdyYWRpZW50CiAgICAgICBpZD0ibGluZWFyR3JhZGllbnQyNjIxNzAiPjxzdG9wCiAgICAgICAgIHN0eWxlPSJzdG9wLWNvbG9yOiMzMjAwNGI7c3RvcC1vcGFjaXR5OjE7IgogICAgICAgICBvZmZzZXQ9IjAiCiAgICAgICAgIGlkPSJzdG9wMjYyMTcxIiAvPjxzdG9wCiAgICAgICAgIHN0eWxlPSJzdG9wLWNvbG9yOiM1YTAwODI7c3RvcC1vcGFjaXR5OjE7IgogICAgICAgICBvZmZzZXQ9IjEiCiAgICAgICAgIGlkPSJzdG9wMjYyMTcwIiAvPjwvbGluZWFyR3JhZGllbnQ+PGxpbmVhckdyYWRpZW50CiAgICAgICBpZD0ibGluZWFyR3JhZGllbnQyNjIxNjUiPjxzdG9wCiAgICAgICAgIHN0eWxlPSJzdG9wLWNvbG9yOiNmMGYwZjA7c3RvcC1vcGFjaXR5OjE7IgogICAgICAgICBvZmZzZXQ9IjAiCiAgICAgICAgIGlkPSJzdG9wMjYyMTY1IiAvPjxzdG9wCiAgICAgICAgIHN0eWxlPSJzdG9wLWNvbG9yOiNkNmQ2ZDY7c3RvcC1vcGFjaXR5OjE7IgogICAgICAgICBvZmZzZXQ9IjAuMDMwMTM4OTgiCiAgICAgICAgIGlkPSJzdG9wMjYyMTY2IiAvPjwvbGluZWFyR3JhZGllbnQ+PGxpbmVhckdyYWRpZW50CiAgICAgICBpZD0ibGluZWFyR3JhZGllbnQyNjIxNjMiPjxzdG9wCiAgICAgICAgIHN0eWxlPSJzdG9wLWNvbG9yOiNmMGYwZjA7c3RvcC1vcGFjaXR5OjE7IgogICAgICAgICBvZmZzZXQ9IjAiCiAgICAgICAgIGlkPSJzdG9wMjYyMTYzIiAvPjxzdG9wCiAgICAgICAgIHN0eWxlPSJzdG9wLWNvbG9yOiNkNmQ3ZDc7c3RvcC1vcGFjaXR5OjE7IgogICAgICAgICBvZmZzZXQ9IjAuMDI3NTI4MyIKICAgICAgICAgaWQ9InN0b3AyNjIxNjQiIC8+PC9saW5lYXJHcmFkaWVudD48bGluZWFyR3JhZGllbnQKICAgICAgIHhsaW5rOmhyZWY9IiNsaW5lYXJHcmFkaWVudDI2MjE2NSIKICAgICAgIGlkPSJsaW5lYXJHcmFkaWVudDI2MjE2OCIKICAgICAgIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIgogICAgICAgeDE9IjEwMC4xNTM5NCIKICAgICAgIHkxPSIxMzEuNzk0ODkiCiAgICAgICB4Mj0iMTA3LjUxNjQzIgogICAgICAgeTI9IjEzMS45MjMyIgogICAgICAgZ3JhZGllbnRUcmFuc2Zvcm09InRyYW5zbGF0ZSgzMC4xNzgxMTksMS40MDAyNTI3KSIgLz48bGluZWFyR3JhZGllbnQKICAgICAgIHhsaW5rOmhyZWY9IiNsaW5lYXJHcmFkaWVudDI2MjE2MyIKICAgICAgIGlkPSJsaW5lYXJHcmFkaWVudDI2MjE2OSIKICAgICAgIGdyYWRpZW50VW5pdHM9InVzZXJTcGFjZU9uVXNlIgogICAgICAgeDE9IjEwMC4xODM0OSIKICAgICAgIHkxPSIxMjUuOTAxNjMiCiAgICAgICB4Mj0iMTA2LjgzMjI0IgogICAgICAgeTI9IjEyNS45MjY2NCIKICAgICAgIGdyYWRpZW50VHJhbnNmb3JtPSJ0cmFuc2xhdGUoMzAuMTc4MTE5LDEuNDAwMjUyNykiIC8+PGxpbmVhckdyYWRpZW50CiAgICAgICB4bGluazpocmVmPSIjbGluZWFyR3JhZGllbnQyNjIxNzAiCiAgICAgICBpZD0ibGluZWFyR3JhZGllbnQyNjIxNzEiCiAgICAgICB4MT0iMTM3LjQ2NTU1IgogICAgICAgeTE9IjEzOC4wMTA1NCIKICAgICAgIHgyPSIxMjQuMTI1MTYiCiAgICAgICB5Mj0iMTI0LjE1MDYyIgogICAgICAgZ3JhZGllbnRVbml0cz0idXNlclNwYWNlT25Vc2UiIC8+PC9kZWZzPjxnCiAgICAgaWQ9ImxheWVyMSIKICAgICB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTIxLjk5NTA0LC0xMjIuMzY2NzUpIj48Y2lyY2xlCiAgICAgICBzdHlsZT0iZmlsbDp1cmwoI2xpbmVhckdyYWRpZW50MjYyMTcxKTtmaWxsLW9wYWNpdHk6MTtmaWxsLXJ1bGU6bm9uemVybztzdHJva2Utd2lkdGg6MC4yNjQ1ODMiCiAgICAgICBpZD0icGF0aDI2MjE2OSIKICAgICAgIGN4PSIxMzAuNDQyMTciCiAgICAgICBjeT0iMTMwLjgxMzg5IgogICAgICAgcj0iOC40NDcxMzk3IiAvPjxwYXRoCiAgICAgICBpZD0icmVjdDI2MjE1My05IgogICAgICAgc3R5bGU9ImZpbGw6I2YyZjJmMjtmaWxsLW9wYWNpdHk6MTtzdHJva2Utd2lkdGg6MC4yNjQ1ODMiCiAgICAgICBkPSJtIDEzMC4zNTk1OSwxMzcuNDIzOTkgYyAtNS4xZS00LDUuM2UtNCAtMC4wMDEsMC4wMDEgLTAuMDAyLDAuMDAyIDEuOWUtNCw3LjFlLTQgMC4wMDEsLTAuMDAxIDAuMDAyLC0wLjAwMiB6IiAvPjxwYXRoCiAgICAgICBpZD0icGF0aDI2MjE1OS0zIgogICAgICAgc3R5bGU9ImZpbGw6dXJsKCNsaW5lYXJHcmFkaWVudDI2MjE2OCk7ZmlsbC1vcGFjaXR5OjE7c3Ryb2tlLXdpZHRoOjAuMjY0NTgzIgogICAgICAgZD0ibSAxMjQuNzAyMDYsMTI5LjIyMjk0IGMgLTAuNDQ2MzIsMC41MDgzNiAtMC44ODkyMywxLjAxOTgzIC0xLjMyOTEyLDEuNTMzNzYgMi41Mzk0LDEuOTgzNjMgNC44MDk3NSw0LjEyMzM1IDYuOTg2NjYsNi42NjcyOSAyLjQ5NjUxLC0yLjU1MjQgNC45NjA1OSwtNC41ODMwNCA3LjMzNDk1LC02LjcwNzYgLTAuNDE0MTMsLTAuNDgzMTUgLTAuODI4MTYsLTAuOTY2MzggLTEuMjQyMywtMS40NDk1MyAtMi4wNTI4MiwxLjU2MjQgLTQuMjM2OTcsMy40MTM2NiAtNi4wNTMzNyw1LjMwMjAxIC0xLjU4NDA2LC0xLjc4MjAxIC0zLjc2MjM5LC0zLjc3NjM2IC01LjY5NjgyLC01LjM0NTkzIHoiIC8+PHBhdGgKICAgICAgIHN0eWxlPSJmaWxsOnVybCgjbGluZWFyR3JhZGllbnQyNjIxNjkpO2ZpbGwtb3BhY2l0eToxO3N0cm9rZS13aWR0aDowLjI2NDU4MyIKICAgICAgIGQ9Im0gMTM1LjgxNDU3LDEyNS42ODYyIGMgLTEuODU4MjIsMS4zMTk1OCAtMy44MjQ5LDIuOTAyNTUgLTUuMzczMzMsNC41ODkzOSAtMS40NzY0MiwtMS42ODIzNSAtMy41NjkzMSwtMy40NzI4MiAtNC45ODUyMiwtNC40OTU4NSAtMC4wNzk4LDAuNDA4MyAtMC4xNTEzNSwxLjQ2NjIgLTAuMDg5OSwyLjUzMzY5IDEuOTcyNDMsMS41MjkxMiAyLjcwODg1LDIuMTUzOTYgNS4xNTU3Niw0LjY0Njc1IDIuNTI3MzIsLTIuNTk1ODUgMy4zMzg5NCwtMy4yODk5OSA1LjI5MjcsLTQuNzQwMjggMC4wODI5LC0wLjk0MDk4IDAuMDc2OCwtMi4wNTc2IDFlLTUsLTIuNTMzNyB6IgogICAgICAgaWQ9InBhdGgyNjIxNTgtMSIgLz48L2c+PC9zdmc+";

    console.log('loading remote');

    function startMessageBox(listId="sse-message-list") {
        return `
            <div style="
                background: rgba(16, 4, 35, 0.8);
                color: white;
                padding: 30px;
                border-radius: 15px;
                max-width: 300px;
                text-align: left;
                font-family: Arial, sans-serif;
            ">
                <div style="
                    text-align: center;
                    padding: 10px;
                    ">
                    <strong>Saving content</strong> <br /><br />
                    <img width=50 src=${logoSvgBase64uri}>

                </div>

                <ul id="${listId}" style="
                    list-style-type: none;
                    padding: 0;
                    margin: 0;
                "></ul>
            </div>`;
    }

    function createPopupList() {

        let dimmer = document.getElementById('page-dimmer');

        if (!dimmer) {

            dimmer = document.createElement('div');
            dimmer.id = 'page-dimmer';
            dimmer.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                z-index: 9998;
            `;
            document.body.appendChild(dimmer);

        }

        let popup = document.getElementById('sse-popup');

        if (!popup) {

            popup = document.createElement('div');
            popup.id = 'sse-popup';
            popup.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                z-index: 9999;
            `;

            popup.innerHTML = startMessageBox()

            document.body.appendChild(popup);
        }
        return { popup, dimmer };
    }

    function showError(message) {
        const errorPopup = document.createElement('div');
        errorPopup.innerHTML = `
            <div style="padding: 10px; background: rgba(255, 0, 0, 0.8); color: white; border-radius: 5px; text-align: center;">
                Savr error: ${message}
            </div>`;
        errorPopup.style.cssText = `
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
        `;
        document.body.appendChild(errorPopup);

        setTimeout(() => {
            errorPopup.style.transition = 'opacity 1s ease-out';
            errorPopup.style.opacity = '0';
            setTimeout(() => errorPopup.remove(), 1000);
        }, 2000);
    }

    function showProgress(percent, message, listId="sse-message-list", mode="append") {

        const messageList = document.getElementById(listId);

        const listItem = document.createElement('li');
        listItem.innerHTML = `<strong>${percent}%</strong> - ${message}`;
        listItem.style.cssText = `
            padding: 5px 0;
            border-bottom: 1p;
        `;

        if (mode == 'append') {
            messageList.appendChild(listItem);
        } else {
            messageList.innerHTML = listItem.outerHTML
        }
    }
    
    function updateProgressList(percent, message) {
        const { popup, dimmer } = createPopupList();
        popup.style.display = 'block';

        showProgress(percent, message)

        if (percent === 100) {
            setTimeout(() => {
                popup.style.transition = 'opacity 1s ease-out';
                popup.style.opacity = '0';
                setTimeout(() => {
                    popup.remove();
                    dimmer.remove();
                }, 1000);
            }, 2000);
        }
    }

    function startSSE(savrHost, currentUrl, completedCallback=null) {
        console.log(`Starting SSE for ${currentUrl}`);

        const source = new EventSource(`${savrHost}/save?url=${encodeURIComponent(currentUrl)}`);
        
        source.onmessage = function(event) {
            const data = JSON.parse(event.data);
            if (data.percent && data.message) {
                updateProgressList(data.percent, data.message);
            }
            if (data.percent == 100) {
                source.close()

                if (completedCallback != null)
                    setTimeout(() => {
                       completedCallback()
                    }, 1000);
            }
        };
        
        source.onerror = function() {
            showError(`Savr error: Could not establish connection for ${currentUrl}`);
        };

    }

    // everything below is for exporting the functions

    /** Used to determine if values are of the language type `Object`. */
    var objectTypes = {
        'function': true,
        'object': true
    };

    function checkGlobal(value) {
        return (value && value.Object === Object) ? value : null;
    }

    /** Detect free variable `exports`. */
    var freeExports = (objectTypes[typeof exports] && exports && !exports.nodeType) ? exports : null;

    /** Detect free variable `module`. */
    var freeModule = (objectTypes[typeof module] && module && !module.nodeType) ? module : null;

    /** Detect free variable `global` from Node.js. */
    var freeGlobal = checkGlobal(freeExports && freeModule && typeof global == 'object' && global);


    var thisGlobal = checkGlobal(objectTypes[typeof this] && this);

    var root = freeGlobal || ((freeWindow !== (thisGlobal && thisGlobal.window)) && freeWindow) || freeSelf || thisGlobal || Function('return this')();

    /** Detect free variable `window`. */
    var freeWindow = checkGlobal(objectTypes[typeof window] && window);

    /** Detect free variable `self`. */
    var freeSelf = checkGlobal(objectTypes[typeof self] && self);

    // window.savrWidgets = {
    //     showError,
    //     updateProgressList,
    //     startMessageBox,
    //     showProgress,
    //     startSSE,
    // };

    // Export to the global object.
    root.savr = {
        showError,
        updateProgressList,
        startMessageBox,
        showProgress,
        startSSE,
    };

})();
